---
title: 5ä¸ªGoçš„deferé™·é˜±
date: 2019-4-10 4:16:25
tags: 
 - Golang
 - develop
abstract: åˆæ˜¯ä¸€ç¯‡è¯‘æ–‡
---

## 1  - nil å‡½æ•° Defer

å½“åœ¨è¿”å›ä¸º nil çš„å‡½æ•°ä¸­ä½¿ç”¨ deferï¼Œå½“è°ƒç”¨ defer æ—¶ï¼ŒåŒ…å« defer çš„å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ä¼šæŠ›å‡º [panics](https://golang.org/ref/spec#Handling_panics)ã€‚

 

###  ç¤ºä¾‹ 

```go
func() {
  var run func() = nil
  defer run()

  fmt.Println("runs")
}
```

###  è¾“å‡º 

```go
runs

â—ï¸ panic: runtime error: invalid memory address or nil pointer dereference
```

###  ä¸ºä»€ä¹ˆï¼Ÿ 

>  åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå‡½æ•°ä¸€ç›´æŒç»­åˆ°ç»“æŸï¼Œåœ¨å‡½æ•°è¿è¡Œ defer ä¹‹åä¼šå› ç‚ºå‡½æ•°ä¸ºé›¶å€¼è€ŒæŠ›å‡º panicã€‚ ä½†æ˜¯ï¼Œ `run()` å‡½æ•°å¯ä»¥æˆåŠŸæ³¨å†Œï¼Œå› ä¸ºåœ¨åŒ…å«å®ƒçš„å‡½æ•°ç»“æŸä¹‹å‰ä¸ä¼šè¢«è°ƒç”¨ã€‚ 
>
>  è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½†åŒæ ·çš„äº‹æƒ…å¯èƒ½å‘ç”Ÿåœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ é‡åˆ°ç±»ä¼¼çš„æƒ…å†µï¼Œé‚£å¯èƒ½æ˜¯åŒæ ·çš„é—®é¢˜ã€‚ 

##   2  - å¾ªç¯ä¸­ defer 

 ä¸è¦åœ¨å¾ªç¯ä¸­ä½¿ç”¨ deferï¼Œé™¤éä½ ç¡®å®šè‡ªå·±åœ¨åšä»€ä¹ˆã€‚ å®ƒå¯èƒ½æ— æ³•æŒ‰è®¾æƒ³è¿è¡Œã€‚ 

 ä½†æ˜¯ï¼Œæœ‰æ—¶åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer ä¼šå¾ˆæ–¹ä¾¿ï¼Œä¾‹å¦‚ï¼Œå°†å‡½æ•°çš„é€’å½’äº¤çµ¦ deferï¼Œä½†æ˜¯è¿™è¶…å‡ºäº†æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ã€‚ 

![img](http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/1.png)

>  åœ¨å‡½æ•°ä¸­ `defer row.Close()` ç›´åˆ°å‡½æ•°çµæŸä¸ä¼šæ‰§è¡Œ - è€Œä¸æ˜¯åœ¨æ¯æ¬¡forå¾ªç¯çš„çµæŸæ—¶æ‰§è¡Œã€‚ è¿™é‡Œçš„æ‰€æœ‰ defer éƒ½ä¼šå ç”¨å‡½æ•°çš„å †ç©ºé—´ï¼Œå¹¶å¯èƒ½ä¼šå¯¼è‡´æ— æ³•é¢„æ–™çš„é—®é¢˜ã€‚ 



###  è§£æ±ºæ–¹æ¡ˆ1ï¼š 

 ç›´æ¥è°ƒç”¨ã€‚ 

![img](http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/2.png)



###  è§£æ±ºæ–¹æ¡ˆ2ï¼š 

 å°†å·¥ä½œå§”æ‰˜ç»™å¦ä¸€ä¸ªå‡½æ•°å¹¶åœ¨é‚£é‡Œä½¿ç”¨deferã€‚ è¿™é‡Œï¼Œdefer å°†åœ¨æ¯æ¬¡åŒ¿åå‡½æ•°ç»“æŸåè¿è¡Œã€‚ 

![img](http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/3.png)



###  å…¶ä»–



> æˆ‘å¯¹å¾ªç¯ä¸­ä½¿ç”¨ defer è¿›è¡Œäº†åŸºå‡†æµ‹è¯•.  #golang Oh boy, defer is hungry. 
>
> https://t.co/WcEoojVeKq
>
> â€”â€Š@inancgumus



<center>ğŸ‘¾ç¤ºä¾‹ä»£ç åœ¨ [**è¿™é‡Œ**](https://play.golang.org/p/GJ7oOMdBwJ) **ğŸ‘¾** </center>



##   3  - åŒ…è£…ä¸­çš„ defer

 æœ‰æ—¶å€™ä½ éœ€è¦ defer ä¸€ä¸ªé—­åŒ…ä¸ºäº†è®©å®ƒæ›´å¥½ç”¨æˆ–å› ä¸ºä¸€äº›å…¶ä»–æˆ‘ä¸èƒ½é¢„æµ‹çš„åŸå› ã€‚ ä¾‹å¦‚ï¼Œè¿æ¥æ•°æ®åº“ï¼Œç„¶åè¿è¡ŒæŸ¥è¯¢ï¼Œæœ€åç¡®ä¿æ–­å¼€è¿æ¥ã€‚ 



###  ç¤ºä¾‹ 

```go
type database struct{}

func (db *database) connect() (disconnect func()) {
  fmt.Println("connect")

  return func() {
    fmt.Println("disconnect")
  }
}
```

###  è¿è¡Œ

```go
db := &database{}
defer db.connect()
 
fmt.Println("query db...") 
```

###  è¾“å‡º

```go
query db...
connect
```

###  ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ 

 è¿™ä¸ªç¤ºä¾‹æ²¡æœ‰æ­£å¸¸è¿æ¥å¹¶æ–­å¼€ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª bugã€‚ è¿™é‡Œ `connect()` è¢«ä¿å­˜äº†èµ·æ¥ï¼Œç›´åˆ°å‡½æ•°ç»“æŸä¹Ÿæ²¡æœ‰è¿è¡Œã€‚ 



###  è§£å†³æ–¹æ¡ˆ

```go
func() {
  db := &database{}

  close := db.connect()
  defer close()
 
  fmt.Println("query db...")
}
```

 è¿™é‡Œ `db.connect()`è¿”å›ä¸€å€‹å‡½æ•°ï¼Œå½“æ•´ä¸ªå‡½æ•°ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥å»¶è¿Ÿæ–­å¼€ä¸æ•°æ®åº“çš„è¿æ¥ã€‚ 

###  è¾“å‡º

```go
connect
query db...
disconnect
```



###   **ä¸å¥½çš„åšæ³•ï¼š** 

 è™½ç„¶è¿™æ˜¯ä¸å¥½çš„åšæ³•ï¼Œä½†æˆ‘æƒ³å‘Šè¯‰ä½ å¦‚ä½•åœ¨æ²¡æœ‰å˜é‡çš„æƒ…å†µä¸‹åšåˆ°è¿™ä¸€ç‚¹ã€‚ æ‰€ä»¥ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½çœ‹åˆ° defer å’Œ Go é€šå¸¸æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ 

```go
func() {
  db := &database{}

  defer db.connect()()

  ..
}
```

 è¿™æ®µä»£ç åœ¨æŠ€æœ¯ä¸Šä¸ä¸Šä¸ªè§£å†³æ–¹æ¡ˆå‡ ä¹ç›¸åŒã€‚ è¿™é‡Œï¼Œç¬¬ä¸€ä¸ªæ‹¬å·ç”¨äºè¿æ¥æ•°æ®åº“ï¼ˆ *åœ¨* `*defer db.connect()*` *ä¸Šç«‹å³æ‰§è¡Œ* ï¼‰ ï¼Œç„¶åç¬¬äºŒä¸ªæ‹¬å·ç”¨äºåœ¨æ•´ä¸ªå‡½æ•°ç»“æŸæ—¶å»¶è¿Ÿè¿è¡Œæ–­å¼€å‡½æ•°ï¼ˆ è¿”å›çš„é—­åŒ…ï¼‰ ã€‚ 

 å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸º`db.connect()`åˆ›å»ºäº†ä¸€ä¸ªå€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªå»¶è¿Ÿæ³¨å†Œé—­åŒ…ã€‚ `db.connect()`çš„å€¼éœ€è¦è¢«è§£æï¼Œå¹¶åœ¨ defer æ—¶æ³¨å†Œã€‚ è¿™ä¸ defer æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä½†å®ƒå¯èƒ½å¯ä»¥è§£å†³ä½ å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚ 



##   4  - åœ¨å—ä¸­ defer

 æ‚¨å¯èƒ½å¸Œæœ› defer çš„å‡½æ•°å°†åœ¨å—ç»“æŸåè¿è¡Œï¼Œä½†å®ƒä¸ä¼šï¼Œå®ƒåªåœ¨åŒ…å«å®ƒçš„å‡½æ•°ç»“æŸåæ‰§è¡Œã€‚ å¯¹äºæ‰€æœ‰å—ä¹Ÿæ˜¯è¿™æ ·ï¼šåŒ…æ‹¬ forï¼Œswitch ç­‰ï¼Œé™¤äº†æˆ‘ä»¬ä¹‹å‰çš„é™·é˜±ä¸­çœ‹åˆ°çš„å‡½æ•°å—å¤–ã€‚ 

>  å› ä¸ºï¼šdeferå±äºä¸€ä¸ªå‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªå—ã€‚ 



####  ç¤ºä¾‹

```go
func main() {

  {
    defer func() {
      fmt.Println("block: defer runs")
    }()

    fmt.Println("block: ends")
  }

  fmt.Println("main: ends")

}
```

####  è¾“å‡º 

```go
block: ends
main: ends
block: defer runs 
```

####  è§£é‡Š

 ä¸Šé¢çš„ defer åªä¼šåœ¨å‡½æ•°ç»“æŸæ—¶æ‰ä¼šè¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨ defer å¤–çš„å—ç»“æŸæ—¶ï¼ˆ åŒ…å«å»¶è¿Ÿè°ƒç”¨çš„èŠ±æ‹¬å·å†…çš„åŒºåŸŸï¼‰ ã€‚ å¦‚ç¤ºä¾‹ä»£ç æ‰€ç¤ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·åˆ›å»ºå•ç‹¬çš„å—ã€‚ 



####  å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ 

 å¦‚æœä½ æƒ³åœ¨ä¸€ä¸ªå—ä¸­è¿è¡Œå»¶è¿Ÿï¼Œä½ å¯ä»¥å°†å®ƒè½¬æ¢ä¸ºfuncï¼Œå¦‚åŒ¿åå‡½æ•°ï¼Œå°±åƒ é—®é¢˜2 çš„è§£å†³æ–¹æ¡ˆä¸€æ ·ã€‚ 

```go
func main() {
  func() {
    defer func() {
      fmt.Println("func: defer runs")
    }()

    fmt.Println("func: ends")
  }()

  fmt.Println("main: ends")
}
```



##   5  - defer method

 ä½ ä¹Ÿå¯ä»¥å°† [methods](https://blog.learngoprogramming.com/go-functions-overview-anonymous-closures-higher-order-deferred-concurrent-6799008dde7b#61ec) å’Œ defer ä¸€èµ·ä½¿ç”¨ã€‚ è¿™æŒºå¥‡æ€ªçš„ï¼Œ è¯·çœ‹ã€‚ 



####  æ²’æœ‰æŒ‡é‡ 

```go
type Car struct {
  model string
}

func (c Car) PrintModel() {
  fmt.Println(c.model)
}

func main() {
  c := Car{model: "DeLorean DMC-12"}

  defer c.PrintModel()

  c.model = "Chevrolet Impala"
}
```

####  è¾“å‡º 

```go
DeLorean DMC-12
```



####  ä½¿ç”¨æŒ‡é‡ 

```go
func (c *Car) PrintModel() {
  fmt.Println(c.model)
}
```

####  è¾“å‡º

```go
Chevrolet Impala
```



####  è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ 



![img](http://lizhongyuan.net/assets/gotchas-of-defer-in-go-1/4.png)

 è¯·è°¨è®°ï¼Œä¼ é€’ç»™ defer çš„å‚æ•°ä¼šç«‹å³ä¿å­˜åˆ°ä¸€è¾¹ï¼Œè€Œä¸å¿…ç­‰å¾… defer è¿è¡Œã€‚ 

 å› æ­¤ï¼Œå½“å¸¦æœ‰ä¼ é€’å€¼æ¥æ”¶å™¨çš„æ–¹æ³•ä¸ defer ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ¥æ”¶å™¨å°†åœ¨æ³¨å†Œæ—¶è¢«å¤åˆ¶ï¼ˆ åœ¨æœ¬ä¾‹ä¸­ä¸º*Car*ï¼‰ ï¼Œå¹¶ä¸”å¯¹å…¶çš„æ›´æ”¹å°†ä¸å¯è§ï¼ˆ *Car.model* ï¼‰ã€‚ å› ä¸ºæ¥æ”¶å™¨ä¹Ÿæ˜¯è¾“å…¥å‚æ•°ï¼Œå¹¶ä¸”å½“å®ƒåœ¨å»¶è¿Ÿæ—¶æ³¨å†Œæ—¶ç«‹å³é‰´å®šä¸ºâ€œDeLorean DMC-12â€ã€‚ 

 å¦ä¸€æ–¹é¢ï¼Œå½“æ¥æ”¶å™¨æ˜¯æŒ‡é’ˆæ—¶å’Œ defer ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°æŒ‡é’ˆï¼Œä½†å®ƒæŒ‡å‘çš„åœ°å€ä¸ä¸Šé¢çš„â€œcâ€æŒ‡é’ˆç›¸åŒã€‚ å› æ­¤ï¼Œå¯¹å®ƒçš„ä»»ä½•æ”¹å˜éƒ½å°†å®Œæ•´åœ°åæ˜ å‡ºæ¥ã€‚ 



---